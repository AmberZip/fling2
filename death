-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- Config
local FlingToggle = false
local DANGER_POS = Vector3.new(-924.05, 304.54, -1.9)
local ESCAPE_DISTANCE = 25
local TARGET_POS = Vector3.new(-1010.16, 329.9, 3.99)

-- GUI Button
local ScreenGui = Instance.new("ScreenGui", PlayerGui)
ScreenGui.Name = "FlingToggleUI"
ScreenGui.ResetOnSpawn = false

local Button = Instance.new("TextButton", ScreenGui)
Button.Size = UDim2.new(0, 120, 0, 40)
Button.Position = UDim2.new(0, 10, 1, -50)
Button.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Button.Text = "Fling [OFF]"
Button.Font = Enum.Font.SourceSansBold
Button.TextSize = 18
Button.BorderSizePixel = 0
Button.BackgroundTransparency = 0.1
Button.AutoButtonColor = false

Button.MouseButton1Click:Connect(function()
	FlingToggle = not FlingToggle
	Button.Text = FlingToggle and "Fling [ON]" or "Fling [OFF]"
end)

-- Helpers
local function getHRP(player)
	local char = player.Character
	return char and char:FindFirstChild("HumanoidRootPart")
end

local function getNearestPlayer()
	local myHRP = getHRP(Player)
	if not myHRP then return nil end

	local closest, shortestDist = nil, math.huge
	for _, other in ipairs(Players:GetPlayers()) do
		if other ~= Player then
			local hrp = getHRP(other)
			if hrp and hrp.Position.Y <= 300 then
				local dist = (myHRP.Position - hrp.Position).Magnitude
				if dist < shortestDist then
					shortestDist = dist
					closest = other
				end
			end
		end
	end
	return closest
end

local function EscapeDanger()
	local char = Player.Character
	local hrp = char and char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	if (hrp.Position - DANGER_POS).Magnitude < ESCAPE_DISTANCE then
		local dir = (hrp.Position - DANGER_POS).Unit
		local safePos = hrp.Position + dir * (ESCAPE_DISTANCE + 10)
		hrp.CFrame = CFrame.new(safePos)
		hrp.Velocity = dir * 150
	end
end

local function SkidFling(target)
	local char = Player.Character
	local hrp = getHRP(Player)
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	local thrp = getHRP(target)
	local thum = target.Character and target.Character:FindFirstChildOfClass("Humanoid")
	if not (char and hrp and hum and thrp and thum and thum.Health > 0) then return end

	hum:SetStateEnabled(Enum.HumanoidStateType.Seated, false)

	local bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = Vector3.zero
	bv.Parent = hrp

	local start = tick()
	while tick() - start < 1.5 and FlingToggle and hum.Health > 0 do
		if not thrp then break end
		local dir = (thrp.Position - hrp.Position).Unit
		bv.Velocity = dir * 500
		hrp.RotVelocity = Vector3.new(9999, 9999, 9999)
		EscapeDanger()
		RunService.Heartbeat:Wait()
	end

	bv:Destroy()
	hum:SetStateEnabled(Enum.HumanoidStateType.Seated, true)
end

-- Fling Loop
task.spawn(function()
	while true do
		if FlingToggle then
			pcall(function()
				local target = getNearestPlayer()
				if target then
					SkidFling(target)
				end
			end)
		end
		EscapeDanger()
		task.wait(0.01)
	end
end)

-- Respawn Glide (if < 2 seconds)
local lastDeathTime = 0

Player.CharacterRemoving:Connect(function()
	lastDeathTime = tick()
end)

Player.CharacterAdded:Connect(function(char)
	local hrp = char:WaitForChild("HumanoidRootPart", 5)
	if hrp and tick() - lastDeathTime <= 2 then
		local goal = { CFrame = CFrame.new(TARGET_POS) }
		local tweenInfo = TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
		local tween = TweenService:Create(hrp, tweenInfo, goal)
		tween:Play()
		tween.Completed:Wait()
	end
end)

-- Greeting
pcall(function()
	StarterGui:SetCore("SendNotification", {
		Title = "Script by AnthonyIsntHere",
		Text = "Toggle fling in bottom left",
		Duration = 5
	})
end)
